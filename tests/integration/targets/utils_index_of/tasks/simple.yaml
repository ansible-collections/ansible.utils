---
- name: Set fact
  ansible.builtin.set_fact:
    complex:
      a: [true, true, false, 5]
      b:
        - b1: 1
          b2: 2
        - b1: 3
          b2: 4
      c:
        c1: ["a", "b", "c"]
      d: ["Abcd", "abcd", "B", "b"]

- name: Some basic tests
  ansible.builtin.assert:
    that: "{{ item.test == item.result }}"
  with_items:
    - test: 0
      result: 0
    - test: "0"
      result: "0"
    - test: [0, 1]
      result: [0, 1]
    - test: [0, 1, 2]
      result: [0, 1, 2]
    - test: "{{ complex.a }}"
      result: [true, true, false, 5]
    - test: "{{ complex.b }}"
      result:
        - b1: 1
          b2: 2
        - b1: 3
          b2: 4
    - test: "{{ complex.c }}"
      result:
        c1: ["a", "b", "c"]
    - test: "{{ complex.d }}"
      result: ["Abcd", "abcd", "B", "b"]

- name: Set fact
  ansible.builtin.set_fact:
    complex:
      a:
        b:
          c:
            d:
              - e0: 0
                e1: ansible
                e2: true
              - e0: 1
                e1: redhat

- name: Find index in list of dictionaries
  ansible.builtin.assert:
    that: "{{ item.test == item.result }}"
  loop:
    - test: "{{ complex.a.b.c.d | ansible.utils.index_of('eq', 'ansible', 'e1') }}"
      result: "0"
    - test: "{{ lookup('ansible.utils.index_of', complex.a.b.c.d, 'eq', 'ansible', 'e1') }}"
      result: "0"
    - test: "{{ complex.a.b.c.d | ansible.utils.index_of('eq', 'ansible', 'e1', wantlist=true) }}"
      result: [0]
    - test: "{{ lookup('ansible.utils.index_of', complex.a.b.c.d, 'eq', 'ansible', 'e1', wantlist=true) }}"
      result: [0]

- name: Test a missing key in the list of dictionaries
  ansible.builtin.assert:
    that: "{{ item.test == item.result }}"
  loop:
    - test: "{{ complex.a.b.c.d | ansible.utils.index_of('eq', true, 'e2') }}"
      result: "0"
    - test: "{{ lookup('ansible.utils.index_of', complex.a.b.c.d, 'eq', true, 'e2') }}"
      result: "0"

- name: Test a missing key in the list of dictionaries, fail on missing
  ansible.builtin.assert:
    that: "{{ item.test == item.result }}"
  loop:
    - test: "{{ complex.a.b.c.d | ansible.utils.index_of('eq', true, 'e2', fail_on_missing=true) }}"
      result: "0"
    - test: "{{ lookup('ansible.utils.index_of', complex.a.b.c.d, 'eq', true, 'e2', fail_on_missing=true) }}"
      result: "0"
  ignore_errors: true
  register: result

- name: Ensure the previous test failed
  ansible.builtin.assert:
    that: "{{ result.failed and 'not found in' in result.msg }}"
