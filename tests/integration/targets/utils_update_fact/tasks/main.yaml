---
- name: Set a fact
  ansible.builtin.set_fact:
    a:
      b:
        c:
          - 1
          - 2
        d:
          "[bracket_key]": bracket_value
          key: value

- name: Update the fact
  ansible.utils.update_fact:
    updates:
      - path: a.b.c.0
        value: 10
      - path: "a['b']['c'][1]"
        value: 20
      - path: "a['b'][d]['[bracket_key]']"
        value: new_bracket_value
      - path: "a['b'][d]['key']"
        value: new_value
  register: updated

- name: Assert
  ansible.builtin.assert:
    that: "{{ updated.a == expected.a }}"
  vars:
    expected:
      a:
        b:
          c:
            - 10
            - 20
          d:
            "[bracket_key]": new_bracket_value
            key: new_value

- name: Update the fact
  ansible.utils.update_fact:
    updates:
      - path: a
        value:
          x:
            y:
              z:
                - 100
                - true
  register: updated

- name: Assert
  ansible.builtin.assert:
    that: "{{ updated.a == expected.a }}"
  vars:
    expected:
      a:
        x:
          y:
            z:
              - 100
              - true

- name: Update the fact
  ansible.utils.update_fact:
    updates:
      - path: "a.b.c[{{ index }}]"
        value: 20
  vars:
    index: "{{ a.b.c | ansible.utils.index_of('eq', 2) }}"
  register: updated

- name: Assert
  ansible.builtin.assert:
    that: "{{ updated.a == expected.a }}"
  vars:
    expected:
      a:
        b:
          c:
            - 1
            - 20
          d:
            "[bracket_key]": bracket_value
            key: value
